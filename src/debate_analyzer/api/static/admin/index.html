<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin – Debate Analyzer</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 800px; margin: 0 auto; padding: 1.5rem; }
    h1 { font-size: 1.5rem; margin-top: 0; }
    section { margin-bottom: 2rem; }
    label { display: block; margin-bottom: 0.25rem; font-weight: 500; }
    input[type="text"] { width: 100%; max-width: 480px; padding: 0.5rem; margin-bottom: 0.5rem; }
    button { padding: 0.5rem 1rem; cursor: pointer; }
    ul { list-style: none; padding: 0; }
    li { margin: 0.5rem 0; padding: 0.5rem; background: #f9f9f9; border-radius: 4px; }
    a { color: #0d6efd; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .err { color: #c00; }
    #loginBox { background: #f0f8ff; padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem; max-width: 320px; }
    #loginBox label { margin-bottom: 0.25rem; }
    #loginBox input[type="text"], #loginBox input[type="password"] { width: 100%; padding: 0.5rem; margin-bottom: 0.5rem; box-sizing: border-box; }
    #loginBox button { margin-top: 0.25rem; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>Admin</h1>
  <p><a href="/">← Public speakers</a></p>

  <div id="loginBox" class="hidden">
    <h2 style="margin-top:0;">Admin login</h2>
    <p>Enter the admin username and password configured on the server.</p>
    <label for="loginUser">Username</label>
    <input type="text" id="loginUser" placeholder="username" autocomplete="username">
    <label for="loginPass">Password</label>
    <input type="password" id="loginPass" placeholder="password" autocomplete="current-password">
    <br>
    <button type="button" id="loginBtn">Log in</button>
    <p id="loginErr" class="err"></p>
  </div>

  <section>
    <h2>Register transcript</h2>
    <p>Enter S3 URI (e.g. <code>s3://bucket/jobs/xxx/transcripts/file.json</code>) or local path (e.g. <code>data/transcripts/file_transcription.json</code>).</p>
    <label for="sourceUri">Source URI or path</label>
    <input type="text" id="sourceUri" placeholder="s3://... or path">
    <label for="title">Title (optional)</label>
    <input type="text" id="title" placeholder="Optional display title">
    <br>
    <button type="button" id="registerBtn">Register</button>
    <p id="registerErr" class="err"></p>
  </section>

  <section>
    <h2>Transcripts</h2>
    <ul id="transcripts"></ul>
    <p id="listErr" class="err"></p>
  </section>

  <script>
    (function () {
      const ADMIN_AUTH_KEY = 'debate_analyzer_admin_auth';
      const listEl = document.getElementById('transcripts');
      const listErr = document.getElementById('listErr');
      const sourceUri = document.getElementById('sourceUri');
      const title = document.getElementById('title');
      const registerBtn = document.getElementById('registerBtn');
      const registerErr = document.getElementById('registerErr');
      const loginBox = document.getElementById('loginBox');
      const loginUser = document.getElementById('loginUser');
      const loginPass = document.getElementById('loginPass');
      const loginBtn = document.getElementById('loginBtn');
      const loginErr = document.getElementById('loginErr');

      function getAuthHeader() {
        try {
          const raw = sessionStorage.getItem(ADMIN_AUTH_KEY);
          return raw ? 'Basic ' + raw : null;
        } catch (_) { return null; }
      }

      function setAuth(user, pass) {
        sessionStorage.setItem(ADMIN_AUTH_KEY, btoa(unescape(encodeURIComponent(user + ':' + pass))));
      }

      function clearAuth() {
        sessionStorage.removeItem(ADMIN_AUTH_KEY);
      }

      function apiFetch(url, options) {
        const headers = { ...(options && options.headers) };
        const auth = getAuthHeader();
        if (auth) headers['Authorization'] = auth;
        return fetch(url, { credentials: 'include', ...options, headers });
      }

      function showLogin(msg) {
        loginBox.classList.remove('hidden');
        listErr.textContent = msg || '';
        loginErr.textContent = '';
      }

      function hideLogin() {
        loginBox.classList.add('hidden');
        listErr.textContent = '';
      }

      function loadTranscripts() {
        listErr.textContent = '';
        apiFetch('/api/admin/transcripts')
          .then(r => {
            if (r.status === 401) {
              clearAuth();
              showLogin('Authentication required. Enter admin username and password below.');
              return { _unauthorized: true };
            }
            return r.ok ? r.json() : Promise.reject(new Error(r.statusText));
          })
          .then(transcripts => {
            if (transcripts && transcripts._unauthorized) return;
            hideLogin();
            if (transcripts.length === 0) {
              listEl.innerHTML = '<li>No transcripts. Register one above.</li>';
              return;
            }
            listEl.innerHTML = transcripts.map(t =>
              '<li><a href="/admin/annotate?transcript_id=' + encodeURIComponent(t.id) + '">' + escapeHtml(t.title || t.source_uri) + '</a> (' + (t.speakers_count || 0) + ' speakers)</li>'
            ).join('');
          })
          .catch(e => { listErr.textContent = e.message; });
      }

      loginBtn.addEventListener('click', function () {
        loginErr.textContent = '';
        const user = loginUser.value.trim();
        const pass = loginPass.value;
        if (!user || !pass) {
          loginErr.textContent = 'Enter username and password.';
          return;
        }
        setAuth(user, pass);
        apiFetch('/api/admin/transcripts')
          .then(r => {
            if (r.status === 401) {
              clearAuth();
              loginErr.textContent = 'Invalid username or password.';
              return;
            }
            if (!r.ok) throw new Error(r.statusText);
            return r.json();
          })
          .then(transcripts => {
            hideLogin();
            if (transcripts && Array.isArray(transcripts)) {
              if (transcripts.length === 0) listEl.innerHTML = '<li>No transcripts. Register one above.</li>';
              else listEl.innerHTML = transcripts.map(t =>
                '<li><a href="/admin/annotate?transcript_id=' + encodeURIComponent(t.id) + '">' + escapeHtml(t.title || t.source_uri) + '</a> (' + (t.speakers_count || 0) + ' speakers)</li>'
              ).join('');
            }
          })
          .catch(e => { loginErr.textContent = e.message; });
      });

      registerBtn.addEventListener('click', function () {
        registerErr.textContent = '';
        if (!getAuthHeader()) {
          showLogin('Log in first, then register transcripts.');
          return;
        }
        const uri = sourceUri.value.trim();
        if (!uri) {
          registerErr.textContent = 'Enter source URI or path.';
          return;
        }
        registerBtn.disabled = true;
        apiFetch('/api/admin/transcripts/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ source_uri: uri, title: title.value.trim() || null }),
        })
          .then(r => r.ok ? r.json() : r.json().then(j => Promise.reject(new Error(j.detail || r.statusText))))
          .then(() => {
            sourceUri.value = '';
            title.value = '';
            loadTranscripts();
          })
          .catch(e => { registerErr.textContent = e.message || (e.detail || ''); })
          .finally(() => { registerBtn.disabled = false; });
      });

      loadTranscripts();
      function escapeHtml(t) {
        const div = document.createElement('div');
        div.textContent = t;
        return div.innerHTML;
      }
    })();
  </script>
</body>
</html>
